<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ  æˆ‘å€‘çš„ç”Ÿæ´»æ‰‹å¸³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --oatmeal: #f5f2ed; --warm-gray: #5d544e; --earth-green: #5a705c; --wood-brown: #8a6d4d; --latte: #e8e2d6; }
        body { background-color: var(--oatmeal); font-family: sans-serif; color: var(--warm-gray); margin: 0; -webkit-tap-highlight-color: transparent; }
        
        /* å¡ç‰‡èˆ‡æŒ‰éˆ•æ”¾å¤§ */
        .warm-card { background: white; border-radius: 28px; border: 1.5px solid var(--latte); margin-bottom: 1.2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .btn-green { background-color: var(--earth-green) !important; color: white !important; border-radius: 20px; font-weight: 800; cursor: pointer; }
        .btn-main { background-color: var(--wood-brown) !important; color: white !important; padding: 18px; border-radius: 20px; font-weight: 800; width: 100%; font-size: 20px; }
        .btn-action-big { padding: 24px !important; font-size: 22px !important; width: 100%; border-radius: 24px; font-weight: 900; }
        
        /* è¼¸å…¥æ¡†èˆ‡æ–‡å­—æ”¾å¤§ */
        .input-box { background: #faf9f7; border: 2px solid var(--latte); border-radius: 18px; padding: 16px; width: 100%; outline: none; font-size: 18px; }
        #randomSlogan { font-size: 18px; line-height: 1.6; min-height: 4.5rem; display: flex; align-items: center; justify-content: center; color: var(--wood-brown); font-weight: 700; padding: 0 25px; text-align: center; }
        
        /* é ç±¤ */
        .tab-active { color: var(--wood-brown); font-weight: 900; position: relative; font-size: 18px; }
        .tab-active::after { content: ''; position: absolute; bottom: -10px; left: 10%; width: 80%; height: 5px; background: var(--wood-brown); border-radius: 10px; }
        
        /* å„²è“„æ ¼å­ */
        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px; }
        .save-cell { aspect-ratio: 1; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 1px solid var(--latte); background: white; cursor: pointer; }
        .cell-done { background: var(--earth-green) !important; color: white !important; border-color: var(--earth-green) !important; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-blur: 5px; }
        .modal-content { background: white; width: 94%; max-width: 440px; border-radius: 36px; padding: 32px; max-height: 85vh; overflow-y: auto; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(245, 242, 237, 0.95); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body class="pb-20">

    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#8a6d4d]"></div>
        <p class="mt-4 text-sm font-bold text-[#8a6d4d]">æ­£åœ¨åŒæ­¥æˆ‘å€‘çš„é¡˜æœ›...</p>
    </div>

    <div class="pt-12 pb-6 text-center">
        <h1 class="text-3xl font-black tracking-tighter text-[#5d544e]">ğŸ  æˆ‘å€‘çš„å®¶</h1>
        <p id="randomSlogan" class="mt-4 italic"></p>
    </div>

    <nav class="sticky top-0 z-50 bg-[#f5f2ed]/95 backdrop-blur-md border-b-2 border-[#e8e2d6] mb-8">
        <div class="max-w-md mx-auto flex justify-around py-6">
            <button onclick="switchPage('ledger')" id="nav-ledger" class="tab-active">è¨˜å¸³æ˜ç´°</button>
            <button onclick="switchPage('savings')" id="nav-savings" class="text-gray-400 font-bold text-lg">å„²è“„è¨ˆç•«</button>
        </div>
    </nav>

    <div class="max-w-md mx-auto px-6">
        <div id="page-ledger">
            <div class="warm-card p-10 text-center shadow-sm">
                <p class="text-[14px] tracking-[0.2em] text-gray-400 font-bold uppercase mb-2">ğŸ‘« å…©äººç¸½é¤˜é¡</p>
                <h2 class="text-5xl font-black text-[#5d544e]" id="balanceDisplay">$ 0</h2>
                <button onclick="fetchCloudData()" class="mt-6 text-sm text-[#8a6d4d] font-bold border-b border-[#8a6d4d] pb-0.5">é»æˆ‘åˆ·æ–°å¸³æœ¬</button>
            </div>

            <div class="warm-card p-8">
                <div class="flex justify-center gap-12 mb-8">
                    <button id="tabExp" onclick="changeType('expense')" class="font-black text-[#8a6d4d] border-b-4 border-[#8a6d4d] pb-1 text-2xl">æ”¯å‡º</button>
                    <button id="tabInc" onclick="changeType('income')" class="text-gray-400 font-black pb-1 text-2xl">æ”¶å…¥</button>
                </div>
                <div class="space-y-6">
                    <input type="date" id="dateInput" class="input-box font-bold">
                    <div class="grid grid-cols-2 gap-4">
                        <select id="catInput" class="input-box font-bold"></select>
                        <select id="methodInput" class="input-box font-bold"></select>
                    </div>
                    <input type="number" id="amtInput" placeholder="å­˜/èŠ±å¤šå°‘éŒ¢å‘¢ï¼Ÿ" class="input-box text-2xl font-black text-[#5a705c]" inputmode="decimal">
                    <input type="text" id="noteInput" placeholder="å¯«é»å‚™è¨»è¨˜éŒ„ç”Ÿæ´» â¤ï¸" class="input-box">
                    <button onclick="saveToCloud()" class="btn-main shadow-xl mt-4">å‹¾é¸è¨˜éŒ„å®Œæˆ</button>
                </div>
            </div>
            <div id="list" class="space-y-4 pb-10"></div>
        </div>

        <div id="page-savings" class="hidden">
            <div class="warm-card p-10 flex justify-between items-center shadow-sm">
                <div>
                    <p class="text-[12px] text-gray-400 font-bold tracking-widest mb-1">å¤¢æƒ³åŸºé‡‘ç¸½é¡</p>
                    <h2 class="text-4xl font-black text-[#5a705c]" id="totalSavingsDisplay">$ 0</h2>
                </div>
                <i class="fas fa-heart text-3xl text-red-300"></i>
            </div>
            <button onclick="openCreateModal()" class="btn-green btn-action-big shadow-lg mb-10">ï¼‹ å»ºç«‹æ–°çš„æœªä¾†è¨ˆç•«</button>
            <div id="goalList" class="space-y-8"></div>
        </div>
    </div>

    <div id="createModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="font-black text-center mb-8 text-2xl">âœ¨ è¨±ä¸‹ä¸€å€‹é¡˜æœ›</h3>
            <div class="space-y-6">
                <input type="text" id="newName" placeholder="è¨ˆç•«åç¨±" class="input-box">
                <input type="number" id="newTarget" placeholder="å–®æ¬¡é‡‘é¡ (å¦‚ï¼š100)" class="input-box" inputmode="numeric">
                <select id="newMode" class="input-box">
                    <option value="365">ğŸ“… 365å¤©æŒ‘æˆ° (1~365æ ¼)</option>
                    <option value="52">ğŸ“… 52é€±æŒ‘æˆ° (52æ ¼)</option>
                    <option value="random">ğŸ² éš¨æ©Ÿå­˜éŒ¢ (50~200å…ƒ)</option>
                    <option value="fixed">ğŸ’° å›ºå®šå­˜éŒ¢ (ç¢ºèªå³å­˜)</option>
                </select>
                <div class="flex gap-4 pt-4">
                    <button onclick="closeModals()" class="flex-1 py-4 text-xl font-bold text-gray-400">å–æ¶ˆ</button>
                    <button onclick="confirmCreate()" class="flex-1 btn-green py-4 text-xl shadow-md">å¥½ï¼Œå»ºç«‹ï¼</button>
                </div>
            </div>
        </div>
    </div>

    <div id="saveActionModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalGoalName" class="font-black text-2xl text-[#5d544e]"></h3>
                <button onclick="closeModals()" class="text-gray-300 p-2"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="modalActionArea"></div>
            <hr class="my-8 border-latte border-2">
            <button onclick="undoLastSave()" class="w-full py-5 mb-3 text-lg text-[#8a6d4d] border-2 border-[#e8e2d6] rounded-2xl font-black">åæ‚”ï¼å–æ¶ˆä¸Šä¸€æ ¼</button>
            <button onclick="deleteCurrentGoal()" class="w-full py-5 text-lg text-red-400 font-black bg-red-50 rounded-2xl mt-4">åˆªé™¤æ­¤è¨ˆç•«</button>
        </div>
    </div>

    <script>
        // ğŸš¨ é‡è¦ï¼šè«‹å°‡å¦³éƒ¨ç½²å¥½çš„ Apps Script ç¶²å€è²¼åœ¨ä¸‹é¢å¼•è™Ÿå…§
        const API_URL = "https://script.google.com/macros/s/AKfycbzLFvZ4VAIVfjukkevj9DSqx-7p3hd0YQZxf16noKfIZXg9Ti3Vkf3YrbQmMlRStVxvKg/exec";
        
        const slogans = [
            "æ¯ä¸€åˆ†å­˜ä¸‹çš„éŒ¢ï¼Œéƒ½æ˜¯æˆ‘å€‘æœªä¾†çš„ç£šå¡Š ğŸ§±",
            "è¦ªæ„›çš„ï¼Œä»Šå¤©ä¹Ÿè¦ä¸€èµ·ç‚ºäº†å¤¢æƒ³åŠªåŠ›å–”ï¼ğŸ’ª",
            "è¾›è‹¦äº†ï¼å¦³å­˜çš„æ¯ä¸€å¡ŠéŒ¢æˆ‘éƒ½é™ªè‘—å¦³ â¤ï¸",
            "ä»Šå¤©çš„å°åŠªåŠ›ï¼Œæ˜¯ç‚ºäº†æ˜å¤©å¤§å¤§çš„é©šå–œ ğŸ",
            "è¬è¬å¦³ï¼Œè·Ÿæˆ‘ä¸€èµ·ç¶“ç‡Ÿé€™ä»½è¸å¯¦çš„å¹¸ç¦ ğŸ±",
            "åªè¦æˆ‘å€‘åœ¨ä¸€èµ·ï¼Œå­˜æ¬¾å¤šå°‘éƒ½æ˜¯å¹¸ç¦çš„ ğŸ¯"
        ];
        
        let records = [];
        let goals = JSON.parse(localStorage.getItem('v14_savings_data')) || [];
        let currentType = 'expense';
        let activeGoalId = null;

        const cats = { expense: ['ğŸ½ï¸ æµªæ¼«æ™šé¤', 'ğŸš— å‡ºéŠäº¤é€š', 'ğŸ›’ å±…å®¶æ—¥å¸¸', 'ğŸ é€å¦³ç¦®ç‰©', 'ğŸ¿ ç´„æœƒé›»å½±', 'ğŸ”§ å…¶ä»–'], income: ['ğŸ’° åŠªåŠ›è–ªè³‡', 'ğŸ§§ é•·è¼©ç´…åŒ…', 'ğŸ“ˆ é¡å¤–æ”¶å…¥'] };
        const methods = { expense: ['ğŸ’µ ç¾é‡‘æ”¯ä»˜', 'ğŸ’³ åˆ·ä¿¡ç”¨å¡', 'ğŸŸ¢ æ•¸ä½æ”¯ä»˜'], income: ['ğŸ¦ éŠ€è¡Œè½‰å¸³', 'ğŸ’µ æ‹¿åˆ°ç¾é‡‘'] };

        window.onload = () => {
            document.getElementById('dateInput').valueAsDate = new Date();
            goals.forEach(g => { if(!Array.isArray(g.history)) g.history = []; });
            refreshForm(); updateSlogan(); renderGoals(); fetchCloudData();
        };

        // --- ä»¥ä¸‹é‚è¼¯æ²¿ç”¨ V14 ä¸¦å„ªåŒ–ç©©å®šæ€§ ---
        function openCreateModal() { document.getElementById('createModal').style.display = 'flex'; }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
        
        function confirmCreate() {
            const name = document.getElementById('newName').value;
            const target = parseFloat(document.getElementById('newTarget').value) || 0;
            const mode = document.getElementById('newMode').value;
            if (!name) return alert("è¦çµ¦è¨ˆç•«èµ·å€‹åå­—å–”ï¼");
            let total = target;
            if (mode === '365') total = 66795;
            if (mode === '52') total = target * 52;
            goals.push({ id: Date.now(), name, target: total, unitAmt: target, mode, current: 0, history: [] });
            saveAndRender(); closeModals();
        }

        function renderGoals() {
            const container = document.getElementById('goalList');
            let total = 0;
            container.innerHTML = goals.map(g => {
                total += g.current;
                const progress = Math.min(100, Math.floor((g.current / g.target) * 100));
                return `<div class="warm-card p-10 shadow-md">
                    <div class="flex justify-between mb-5"><h4 class="font-black text-2xl">${g.name}</h4><span class="text-lg font-black text-[#5a705c]">${progress}%</span></div>
                    <div class="w-full bg-gray-100 rounded-full h-5 mb-8 overflow-hidden shadow-inner"><div class="bg-[#5a705c] h-full" style="width:${progress}%"></div></div>
                    <div class="flex justify-between items-center"><span class="text-sm font-black text-[#8a6d4d]">å·²å­˜: $${g.current.toLocaleString()}</span><button onclick="openSaveAction(${g.id})" class="btn-green px-12 py-5 text-lg font-black shadow-xl">é»æˆ‘å­˜éŒ¢</button></div>
                </div>`;
            }).join('');
            document.getElementById('totalSavingsDisplay').innerText = '$ ' + total.toLocaleString();
        }

        function openSaveAction(id) {
            activeGoalId = id;
            const g = goals.find(x => x.id === id);
            document.getElementById('modalGoalName').innerText = g.name;
            const area = document.getElementById('modalActionArea');
            area.innerHTML = '';

            if (g.mode === '365' || g.mode === '52') {
                const count = (g.mode === '365') ? 365 : 52;
                area.innerHTML = `<div class="grid-container" id="cellGrid"></div>`;
                const grid = area.querySelector('#cellGrid');
                for (let i = 1; i <= count; i++) {
                    const amt = (g.mode === '365') ? i : g.unitAmt;
                    const isDone = (g.mode === '365') ? g.history.includes(i) : g.history.length >= i;
                    grid.innerHTML += `<div onclick="${isDone?'':'doSave('+amt+','+i+')'}" class="save-cell ${isDone?'cell-done':''}">$${amt}</div>`;
                }
            } else if (g.mode === 'random') {
                const rand = Math.floor(Math.random() * (200 - 50 + 1)) + 50;
                area.innerHTML = `<div class="text-center py-8"><h1 class="text-6xl font-black text-[#8a6d4d] mb-10">$ ${rand}</h1><button onclick="doSave(${rand}, ${rand})" class="btn-green btn-action-big shadow-2xl">å­˜å…¥é€™ç­†å¹¸ç¦ â¤ï¸</button></div>`;
            } else {
                area.innerHTML = `<div class="text-center py-8"><h1 class="text-6xl font-black text-[#5a705c] mb-10">$ ${g.unitAmt}</h1><button onclick="doSave(${g.unitAmt}, ${g.unitAmt})" class="btn-green btn-action-big shadow-2xl">ç¢ºèªå­˜å…¥ï¼</button></div>`;
            }
            document.getElementById('saveActionModal').style.display = 'flex';
        }

        function doSave(amt, marker) {
            const g = goals.find(x => x.id === activeGoalId);
            g.current += amt; g.history.push(marker);
            saveAndRender(); openSaveAction(activeGoalId);
        }

        function undoLastSave() {
            const g = goals.find(x => x.id === activeGoalId);
            if (g.history.length === 0) return;
            const lastMarker = g.history.pop();
            const amtToSubtract = (g.mode === '365') ? lastMarker : (g.mode === '52' ? g.unitAmt : lastMarker);
            g.current -= amtToSubtract;
            saveAndRender(); openSaveAction(activeGoalId);
        }

        async function fetchCloudData() {
            toggleLoader(true);
            try { const res = await fetch(API_URL); records = (await res.json()).reverse(); renderLedger(); } catch (e) { console.error(e); }
            toggleLoader(false);
        }

        async function saveToCloud() {
            const amtElem = document.getElementById('amtInput');
            if (!amtElem.value) return alert("è¦è¼¸å…¥é‡‘é¡å–”ï¼");
            const data = { date: document.getElementById('dateInput').value, type: currentType, cat: document.getElementById('catInput').value, method: document.getElementById('methodInput').value, attr: 'å…±åŒç”Ÿæ´»', amt: parseFloat(amtElem.value), note: document.getElementById('noteInput').value };
            toggleLoader(true);
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                amtElem.value = ''; document.getElementById('noteInput').value = '';
                setTimeout(fetchCloudData, 1500);
            } catch (e) { toggleLoader(false); }
        }

        function renderLedger() {
            const list = document.getElementById('list');
            let bal = 0;
            records.forEach(r => bal += (r.type === 'income' ? Number(r.amt) : -Number(r.amt)));
            document.getElementById('balanceDisplay').innerText = '$ ' + bal.toLocaleString();
            list.innerHTML = records.slice(0, 15).map(r => `<div class="warm-card p-6 flex justify-between items-center border-none shadow-sm bg-[#faf9f7]"><div><span class="font-black text-lg text-[#5d544e]">${r.cat}</span><p class="text-[12px] text-gray-400 mt-1 font-bold">${r.date} ${r.note?'Â· '+r.note:''}</p></div><p class="font-black text-xl ${r.type==='income'?'text-[#5a705c]':'text-[#8a6d4d]'}">${r.type==='income'?'+':'-'}${Number(r.amt).toLocaleString()}</p></div>`).join('');
        }

        function saveAndRender() { localStorage.setItem('v14_savings_data', JSON.stringify(goals)); renderGoals(); }
        function deleteCurrentGoal() { if(confirm("ç¢ºå®šåˆªé™¤å—ï¼Ÿ")) { goals = goals.filter(g => g.id !== activeGoalId); saveAndRender(); closeModals(); } }
        function switchPage(p) {
            document.getElementById('page-ledger').classList.toggle('hidden', p !== 'ledger');
            document.getElementById('page-savings').classList.toggle('hidden', p !== 'savings');
            document.getElementById('nav-ledger').className = p === 'ledger' ? 'tab-active' : 'text-gray-400 font-bold text-lg';
            document.getElementById('nav-savings').className = p === 'savings' ? 'tab-active' : 'text-gray-400 font-bold text-lg';
            updateSlogan();
        }
        function changeType(t) { currentType = t; refreshForm(); }
        function refreshForm() {
            document.getElementById('catInput').innerHTML = cats[currentType].map(c => `<option>${c}</option>`).join('');
            document.getElementById('methodInput').innerHTML = methods[currentType].map(m => `<option>${m}</option>`).join('');
            document.getElementById('tabExp').className = currentType==='expense'?'font-black text-[#8a6d4d] border-b-4 border-[#8a6d4d] pb-1 text-2xl':'text-gray-400 font-black pb-1 text-2xl';
            document.getElementById('tabInc').className = currentType==='income'?'font-black text-[#5a705c] border-b-4 border-[#5a705c] pb-1 text-2xl':'text-gray-400 font-black pb-1 text-2xl';
        }
        function updateSlogan() { document.getElementById('randomSlogan').innerText = slogans[Math.floor(Math.random() * slogans.length)]; }
        function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    </script>
</body>
</html>
